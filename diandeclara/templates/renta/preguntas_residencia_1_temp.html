{% extends "base.html" %}
{% block content %}
<div class="container-fluid bg-light min-vh-100">
  <!-- Header institucional DIAN, igual al home -->
  <div class="container-fluid px-0">
    <div class="row" style="background-color: transparent;">
      <div class="col-lg-1 col-sm-2 col-4 d-flex align-items-center justify-content-center py-1" style="background: #3366CC 0% 0% no-repeat padding-box;">
        <a href="https://www.gov.co">
          <img src="/static/images/logo_header.png" alt="logo GOV.CO" style="max-height:40px;max-width:100%;width:auto;height:auto;display:block;margin:auto;">
        </a>
      </div>
      <div class="col-lg-11 col-sm-10 col-8 d-flex align-items-center py-1" style="background: #E5EEFB 0% 0% no-repeat padding-box;">
        <span class="fw-bold text-primary ms-2" style="font-size: 0.5rem;">Dirección de Impuestos y Aduanas Nacionales</span>
      </div>
    </div>
  </div>

  <!-- Breadcrumb y Progress -->
  <div class="container py-3">
    <div class="row">
      <div class="col-12">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">← Declaración de renta personas naturales</a></li>
            <li class="breadcrumb-item active">Haga su declaración de renta</li>
          </ol>
        </nav>
        
        <!-- Progress Steps -->
        <div class="d-flex justify-content-center mb-4">
          <div class="d-flex align-items-center">
            <div class="step-circle active">1</div>
            <div class="step-line"></div>
            <div class="step-circle">2</div>
            <div class="step-line"></div>
            <div class="step-circle">3</div>
            <div class="step-line"></div>
            <div class="step-circle">4</div>
            <div class="step-line"></div>
            <div class="step-circle">5</div>
          </div>
        </div>
        <div class="d-flex justify-content-center mb-4 small">
          <span class="text-success fw-bold me-4">Pregunta(s) inicial(es)</span>
          <span class="text-muted me-4">Formulario 210</span>
          <span class="text-muted me-4">Firmar</span>
          <span class="text-muted me-4">Presentar</span>
          <span class="text-muted">Pagar</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <div class="card shadow-sm">
          <div class="card-header bg-white border-bottom">
            <h4 class="mb-0">Pregunta(s) inicial(es)</h4>
            <p class="text-muted mb-0">Las siguientes preguntas ayudarán a determinar su residencia fiscal para efectos tributarios, y así saber qué formulario debe utilizar para su declaración de renta del año gravable 2024.</p>
          </div>
          <div class="card-body">
            <form method="post" id="residenciaForm">{% csrf_token %}
              <input type="hidden" name="paso" value="1">
              
              <div class="mb-4">
                <div class="d-flex align-items-center mb-3">
                  <label class="form-label fw-bold mb-0" id="pregunta-residencia">¿Cuál fue su tiempo de permanencia en Colombia durante el año 2024?</label>
                  <button type="button" class="btn btn-outline-info btn-sm ms-2 btn-help" data-question-id="pregunta-residencia" data-bs-toggle="tooltip" data-bs-placement="top" title="Esta pregunta determina su residencia fiscal colombiana según el artículo 10 del Estatuto Tributario. Si permaneció más de 183 días será considerado residente fiscal.">
                    <i class="bi bi-info-circle"></i>
                  </button>
                </div>
                
                <div class="form-check mb-2">
                  <input class="form-check-input" type="radio" name="residencia_2024" id="mayor" value="mayor" required>
                  <label class="form-check-label" for="mayor">
                    <strong>Mayor a 183 días calendario continuos o discontinuos</strong>
                    <br><small class="text-muted">Se considera residente fiscal para efectos tributarios</small>
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="residencia_2024" id="menor" value="menor">
                  <label class="form-check-label" for="menor">
                    <strong>Menor o igual a 183 días calendario continuos o discontinuos</strong>
                    <br><small class="text-muted">Puede ser considerado no residente fiscal</small>
                  </label>
                </div>
                
                <div id="help-text" class="alert alert-info mt-3" style="display: none;">
                  <h6><i class="bi bi-lightbulb"></i> Información adicional:</h6>
                  <ul class="mb-0 small">
                    <li><strong>Residente fiscal:</strong> Debe declarar todos sus ingresos mundiales</li>
                    <li><strong>No residente:</strong> Solo declara ingresos de fuente nacional</li>
                    <li><strong>Días de permanencia:</strong> Se cuentan desde entrada hasta salida del país</li>
                    <li><strong>Interrupciones:</strong> Los días no necesitan ser continuos</li>
                  </ul>
                </div>
              </div>
              
              <div class="mb-4">
                <div class="d-flex align-items-center mb-3">
                  <label class="form-label fw-bold mb-0" id="pregunta-domicilio">¿Tiene su domicilio o residencia permanente en Colombia?</label>
                  <button type="button" class="btn btn-outline-info btn-sm ms-2 btn-help" data-question-id="pregunta-domicilio" data-bs-toggle="tooltip" data-bs-placement="top" title="La residencia permanente se refiere a donde tiene su casa-habitación o asiento principal de sus negocios, considerando vínculos personales y económicos.">
                    <i class="bi bi-info-circle"></i>
                  </button>
                </div>
                
                <div class="form-check mb-2">
                  <input class="form-check-input" type="radio" name="domicilio_colombia" id="domicilio-si" value="si" required>
                  <label class="form-check-label" for="domicilio-si">
                    <strong>Sí</strong>
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="domicilio_colombia" id="domicilio-no" value="no">
                  <label class="form-check-label" for="domicilio-no">
                    <strong>No</strong>
                  </label>
                </div>
              </div>
              
              <div class="mb-4">
                <div class="d-flex align-items-center mb-3">
                  <label class="form-label fw-bold mb-0" id="pregunta-conyuge">¿Su cónyuge o compañero(a) permanente, o hijos dependientes, tienen residencia fiscal en Colombia?</label>
                  <button type="button" class="btn btn-outline-info btn-sm ms-2 btn-help" data-question-id="pregunta-conyuge" data-bs-toggle="tooltip" data-bs-placement="top" title="Esta pregunta evalúa su vínculo familiar como criterio adicional de residencia fiscal según el ET.">
                    <i class="bi bi-info-circle"></i>
                  </button>
                </div>
                
                <div class="form-check mb-2">
                  <input class="form-check-input" type="radio" name="familia_residencia" id="familia-si" value="si" required>
                  <label class="form-check-label" for="familia-si">
                    <strong>Sí</strong>
                  </label>
                </div>
                <div class="form-check mb-2">
                  <input class="form-check-input" type="radio" name="familia_residencia" id="familia-no" value="no">
                  <label class="form-check-label" for="familia-no">
                    <strong>No</strong>
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="familia_residencia" id="familia-na" value="na">
                  <label class="form-check-label" for="familia-na">
                    <strong>No aplica</strong> (no tengo cónyuge, compañero(a) permanente, ni hijos)
                  </label>
                </div>
              </div>
              
              <div class="mb-4">
                <div class="d-flex align-items-center mb-3">
                  <label class="form-label fw-bold mb-0" id="pregunta-ingresos">¿El 50% o más de sus ingresos se originan en Colombia?</label>
                  <button type="button" class="btn btn-outline-info btn-sm ms-2 btn-help" data-question-id="pregunta-ingresos" data-bs-toggle="tooltip" data-bs-placement="top" title="Esta pregunta evalúa la fuente principal de sus ingresos como criterio de residencia fiscal.">
                    <i class="bi bi-info-circle"></i>
                  </button>
                </div>
                
                <div class="form-check mb-2">
                  <input class="form-check-input" type="radio" name="ingresos_colombia" id="ingresos-si" value="si" required>
                  <label class="form-check-label" for="ingresos-si">
                    <strong>Sí</strong>
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="ingresos_colombia" id="ingresos-no" value="no">
                  <label class="form-check-label" for="ingresos-no">
                    <strong>No</strong>
                  </label>
                </div>
              </div>
              
              <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                <button type="submit" class="btn btn-primary px-4">
                  Continuar <i class="bi bi-arrow-right ms-1"></i>
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Botón flotante del asistente -->
<button id="assistant-btn" class="btn btn-primary rounded-circle position-fixed" style="bottom: 30px; right: 30px; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; z-index: 1000;">
  <i class="bi bi-robot fs-4"></i>
</button>

<!-- Estilos CSS adicionales -->
<style>
.step-circle {
  width: 35px;
  height: 35px;
  border-radius: 50%;
  background-color: #e9ecef;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: #6c757d;
  margin: 0 5px;
}

.step-circle.active {
  background-color: #198754;
  color: white;
}

.step-line {
  height: 3px;
  width: 50px;
  background-color: #e9ecef;
}

/* Estilos para el botón del asistente */
#assistant-btn {
  box-shadow: 0 6px 20px rgba(0,0,0,0.2);
  transition: all 0.3s ease;
}

#assistant-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 8px 25px rgba(0,0,0,0.3);
}

/* Efecto de pulsación para llamar la atención */
@keyframes pulse {
  0% {
    box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.7);
    transform: scale(1);
  }
  70% {
    box-shadow: 0 0 0 15px rgba(0, 123, 255, 0);
    transform: scale(1.05);
  }
  100% {
    box-shadow: 0 0 0 0 rgba(0, 123, 255, 0);
    transform: scale(1);
  }
}

.pulse-effect {
  animation: pulse 1s ease-in-out;
}

@keyframes bounceInTop {
  0% {
    opacity: 0;
    transform: translate(20px, -500px) rotate(10deg);
  }
  40% {
    opacity: 0.6;
    transform: translate(0, 20px) rotate(-5deg);
  }
  60% {
    opacity: 1;
    transform: translate(0, -15px) rotate(3deg);
  }
  75% {
    transform: translate(0, 10px) rotate(-2deg);
  }
  90% {
    transform: translate(0, -5px) rotate(1deg);
  }
  100% {
    transform: translate(0, 0) rotate(0);
  }
}
</style>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Función principal para manejar la acción de ayuda
    function handleHelpAction(questionElement) {
        if (questionElement) {
            // Extraer el texto de la pregunta
            var questionText = questionElement.textContent.trim();
            console.log("Pregunta seleccionada:", questionText);
            
            // Esperar un momento para que la UI se actualice antes de interactuar con el asistente
            setTimeout(function() {
                try {
                    // Buscar los elementos del asistente
                    console.log("Buscando elementos del asistente");
                    var assistantModal = document.getElementById('assistantModal');
                    var assistantOptions = document.getElementById('assistant-options');
                    var voiceInterface = document.getElementById('voice-interface');
                    var chatInterface = document.getElementById('chat-interface');
                    var chatBtn = document.querySelector('.chat-icon-container');
                    
                    // Verificar si el asistente está cargado
                    if (!assistantModal) {
                        console.error("No se encontró el modal del asistente");
                        return;
                    }
                    
                    // Si el modal no está visible, mostrarlo
                    if (assistantModal.style.display !== 'block') {
                        console.log("Modal del asistente no visible, activándolo");
                        
                        // Si hay un botón para abrir el asistente, lo activamos
                        var assistantBtn = document.getElementById('assistant-btn');
                        if (assistantBtn) {
                            console.log("Abriendo asistente mediante botón");
                            assistantBtn.click();
                        } else {
                            // Si no hay botón, mostrar directamente el modal
                            console.log("Mostrando asistente manualmente");
                            assistantModal.style.display = 'block';
                        }
                    }
                    
                    // Asegurar que la interfaz de voz esté oculta si existe
                    if (voiceInterface) {
                        console.log("Ocultando interfaz de voz");
                        voiceInterface.style.display = 'none';
                    }
                    
                    // Luego activar la interfaz de chat si no está activa
                    if (assistantOptions && chatInterface) {
                        console.log("Activando interfaz de chat");
                        
                        // Asegurarse de que se muestre la interfaz de chat y no otras
                        if (chatBtn && chatInterface.style.display !== 'flex') {
                            console.log("Activando chat mediante botón");
                            chatBtn.click();
                            
                            // Doble verificación para asegurar que el chat esté activo
                            setTimeout(function() {
                                if (chatInterface.style.display !== 'flex') {
                                    console.log("Activando chat manualmente después del click");
                                    if (assistantOptions) assistantOptions.style.display = 'none';
                                    chatInterface.style.display = 'flex';
                                    chatInterface.style.flexDirection = 'column';
                                    chatInterface.style.height = '100%';
                                }
                            }, 200);
                        } else {
                            // Activar manualmente la interfaz de chat
                            console.log("Activando chat manualmente");
                            if (assistantOptions) assistantOptions.style.display = 'none';
                            chatInterface.style.display = 'flex';
                            chatInterface.style.flexDirection = 'column';
                            chatInterface.style.height = '100%';
                        }
                    }
                    
                    // Buscar el campo de entrada del chat del asistente
                    var chatInput = document.getElementById('chat-input');
                    var sendButton = document.getElementById('send-message');
                    
                    // Si encontramos los elementos, enviamos la pregunta
                    if (chatInput && sendButton) {
                        // Formar la pregunta para el asistente
                        chatInput.value = "Dame más información acerca de la pregunta: " + questionText;
                        console.log("Pregunta preparada:", chatInput.value);
                        
                        // Disparar eventos para que el sistema reconozca el cambio
                        chatInput.dispatchEvent(new Event('input', { bubbles: true }));
                        
                        // Enviar el mensaje
                        console.log("Enviando pregunta al asistente");
                        sendButton.click();
                        
                        // Asegurarse que la respuesta se lea en voz alta
                        setTimeout(function() {
                            console.log("Procesando respuesta para reproducción por voz");
                            
                            // Buscar específicamente mensajes del bot en la interfaz de chat
                            var chatMessages = document.querySelector('.chat-messages');
                            
                            if (chatMessages) {
                                // Contar los mensajes actuales del bot
                                var currentBotMessages = chatMessages.querySelectorAll('.bot-message');
                                var initialCount = currentBotMessages.length;
                                console.log("Mensajes actuales del bot:", initialCount);
                                
                                // Esperar a que aparezca un nuevo mensaje (respuesta a nuestra pregunta)
                                var checkForNewMessage = function() {
                                    var newBotMessages = chatMessages.querySelectorAll('.bot-message');
                                    
                                    // Si hay un nuevo mensaje, reproducirlo
                                    if (newBotMessages.length > initialCount) {
                                        var lastMessage = newBotMessages[newBotMessages.length - 1];
                                        var messageText = lastMessage.textContent.trim();
                                        
                                        // Verificar que el mensaje no sea de la interfaz de voz
                                        if (messageText.includes("Presiona el micrófono") || messageText.includes("Te escucharé")) {
                                            console.log("Detectado mensaje de interfaz de voz, ignorando...");
                                            return;
                                        }
                                        
                                        console.log("Nuevo mensaje encontrado para reproducir:", messageText.substring(0, 50) + "...");
                                        
                                        // Ajustar el scroll para que el mensaje sea visible
                                        chatMessages.scrollTop = chatMessages.scrollHeight;
                                        
                                        // Detener cualquier síntesis de voz anterior
                                        if ('speechSynthesis' in window) {
                                            window.speechSynthesis.cancel();
                                        }
                                        
                                        // Reproducir por voz la respuesta
                                        if ('speechSynthesis' in window && messageText) {
                                            console.log("Reproduciendo respuesta por voz");
                                            var utter = new SpeechSynthesisUtterance(messageText);
                                            utter.lang = 'es-ES';
                                            utter.rate = 0.9;
                                            utter.pitch = 1.1;
                                            utter.volume = 1.0;
                                            
                                            // Manejar eventos de la síntesis de voz
                                            utter.onstart = function() {
                                                console.log("Síntesis de voz iniciada");
                                            };
                                            
                                            utter.onend = function() {
                                                console.log("Síntesis de voz finalizada");
                                            };
                                            
                                            utter.onerror = function(event) {
                                                console.error("Error en síntesis de voz:", event.error);
                                            };
                                            
                                            window.speechSynthesis.speak(utter);
                                        } else {
                                            console.error("Speech synthesis no disponible o mensaje vacío");
                                        }
                                    } else {
                                        // Si aún no hay nuevo mensaje, seguir esperando
                                        console.log("Esperando respuesta del asistente...");
                                        setTimeout(checkForNewMessage, 500); // Revisar cada 500ms
                                    }
                                };
                                
                                // Comenzar a verificar si hay nuevos mensajes
                                checkForNewMessage();
                                
                                // Asegurar que los elementos internos del chat estén bien dimensionados
                                var chatInterfaceElement = document.getElementById('chat-interface');
                                if (chatInterfaceElement) {
                                    chatInterfaceElement.style.display = 'flex';
                                    chatInterfaceElement.style.flexDirection = 'column';
                                    chatInterfaceElement.style.height = '100%';
                                    chatInterfaceElement.style.overflow = 'hidden';
                                }
                            }
                        }, 1500); // Tiempo para que el mensaje aparezca
                    }
                } catch (error) {
                    console.error("Error al interactuar con el asistente:", error);
                }
            }, 800);
        }
    }
    
    // Seleccionar todos los botones de ayuda y asignarles la función
    var helpButtons = document.querySelectorAll('.btn-help');
    
    // Configurar la acción para cada botón de ayuda
    helpButtons.forEach(function(button) {
        button.addEventListener('click', function(event) {
            // Evitar propagación para no activar otros manejadores de eventos
            event.stopPropagation();
            event.preventDefault();
            
            // Obtener el ID de la pregunta asociada al botón
            var questionId = this.getAttribute('data-question-id');
            var questionElement = document.getElementById(questionId);
            
            if (questionElement) {
                // Llamar a la función que procesa la ayuda
                handleHelpAction(questionElement);
            }
        });
    });
});
</script>
{% endblock %}
